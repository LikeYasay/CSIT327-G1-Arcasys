{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/css/login.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
    /* Server-side auth error styling */
    .auth-error {
        color: #dc3545;
        text-align: center;
    }

    /* Field error styling */
    .field-error {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        display: block;
    }

    .error-border {
        border: 2px solid #dc3545 !important;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-container">

  <div class="login-left">
    <header class="login-header">
      <div class="logo-section">
        <img src="{% static 'shared/images/CIT_LOGO.png' %}" alt="CIT Logo" class="logo" />
        <div class="logo-text">
          <h1>MARKETING ARCHIVE</h1>
          <p>Event Management System</p>
        </div>
      </div>
      <a href="{% url 'marketing:landing' %}" class="back-link">‚Üê Back</a>
    </header>

    <div class="login-card">
      <h1>Welcome Back</h1>
      <p class="description">Enter your details to proceed.</p>

      <!-- Server-side authentication errors (non-bulleted) -->
      {% for message in messages %}
        {% if 'auth_error' in message.tags %}
          <div class="auth-error">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Login Form -->
      <form method="POST" autocomplete="off">
        {% csrf_token %}

        <!-- Hidden fake fields to trick autofill -->
        <input type="email" name="fake_email" style="display:none">
        <input type="password" name="fake_password" style="display:none">

        <label for="email">Email</label>
        <input 
          type="email" 
          name="email" 
          id="email" 
          placeholder="Enter your email" 
          required 
          autocomplete="off" 
          readonly onfocus="this.removeAttribute('readonly')"
          value="{% if not clear_fields.email %}{{ form_data.email|default:'' }}{% endif %}"
          class="{% if field_errors.email %}error-border{% endif %}"
        >
        {% if field_errors.email %}
          <span class="field-error">{{ field_errors.email }}</span>
        {% endif %}

        <label for="password">Password</label>
        <div class="password-wrapper">
          <input
            type="password"
            name="password"
            id="password"
            placeholder="Enter your password"
            required
            autocomplete="off"
            readonly onfocus="this.removeAttribute('readonly')"
            value="{% if not clear_fields.password %}{{ form_data.password|default:'' }}{% endif %}"
            class="{% if field_errors.password %}error-border{% endif %}"
          />
          <span class="toggle-password">
            <i class="fas fa-eye-slash" id="togglePasswordIcon"></i>
          </span>
        </div>
        {% if field_errors.password %}
          <span class="field-error">{{ field_errors.password }}</span>
        {% endif %}

        <div class="options">
          <label>
            <input type="checkbox" name="remember_me" id="remember_me">
            Remember me
          </label>
         <a href="{% url 'users:password_reset' %}" class="forgot-link">Forgot password?</a>
        </div>

        <button type="submit" class="btn-login">Log in</button>
      </form>

      <p class="signup-text">
        <a href="{% url 'users:register' %}">Signup</a>
      </p>
    </div>
  </div>

  <div class="login-right">
    <img src="{% static 'marketing/images/GLE-CIT.png' %}" alt="Campus Building">
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Password visibility toggle
    const toggleIcon = document.getElementById("togglePasswordIcon");
    const passwordInput = document.getElementById("password");

    if (toggleIcon && passwordInput) {
      toggleIcon.addEventListener("click", function() {
        const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
        passwordInput.setAttribute("type", type);
        this.classList.toggle("fa-eye-slash");
        this.classList.toggle("fa-eye");
      });
    }

    // Check if user previously unchecked "Remember me"
    const userExplicitlyUnchecked = localStorage.getItem('dontRememberMe');
    
    // Only auto-fill if there are no validation errors and user didn't explicitly uncheck
    const hasValidationErrors = {% if messages or field_errors %}true{% else %}false{% endif %};
    
    if (!userExplicitlyUnchecked && !hasValidationErrors) {
      // Auto-fill only if user didn't explicitly uncheck and no validation errors
      const rememberedEmail = getCookie('remembered_email');
      const rememberedPassword = getCookie('remembered_password');
      const rememberMeCheckbox = document.getElementById('remember_me');
      
      if (rememberedEmail) {
          const cleanEmail = cleanCookieValue(rememberedEmail);
          document.getElementById('email').value = cleanEmail;
          rememberMeCheckbox.checked = true;
      }
      
      if (rememberedPassword) {
          const cleanPassword = cleanCookieValue(rememberedPassword);
          document.getElementById('password').value = cleanPassword;
      }
    }

    // Track when user explicitly unchecks "Remember me"
    const rememberMeCheckbox = document.getElementById('remember_me');
    if (rememberMeCheckbox) {
      rememberMeCheckbox.addEventListener('change', function() {
        if (!this.checked) {
            // User explicitly doesn't want to be remembered
            localStorage.setItem('dontRememberMe', 'true');
            // Clear the fields immediately
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        } else {
            // User wants to be remembered again
            localStorage.removeItem('dontRememberMe');
        }
      });
    }

    // Helper functions
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    function cleanCookieValue(value) {
      if (!value) return '';
      let cleaned = value.replace(/^"(.*)"$/, '$1');
      try {
          cleaned = decodeURIComponent(cleaned);
      } catch (e) {
          // If URL decoding fails, use the value as is
      }
      cleaned = cleaned.replace(/^"+|"+$/g, '');
      return cleaned;
    }
  });
</script>
{% endblock %}