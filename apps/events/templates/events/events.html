{% extends "base.html" %}

{% load static %}

{% block title %}
Events | Marketing Archive
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'events/css/events.css' %}" />
{% endblock %}

{% block content %}
<section class="events-container">
  <h1 class="page-title">Search for Events</h1>

  {% if messages %}
  <div class="messages">
    {% for message in messages %}
    <div class="alert alert-error">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="search-bar {% if messages %}error{% endif %}">
    <img src="{% static 'events/images/search-icon.png' %}" alt="Search Icon" class="search-icon"
      style="width:18px;height:18px;max-width:18px;max-height:18px;flex:0 0 18px;display:block;object-fit:contain;margin-right:10px;" />
    <form method="get" action="{% url 'events:events' %}" style="display: flex; width: 100%;">
      <input id="search-input" type="text" name="q" placeholder="Search events, departments, tags..." autocomplete="off"
        value="{{ search_query|default:'' }}" />
      <button type="submit" style="display: none;">Search</button>
    </form>
    <ul id="typeahead-results" class="typeahead-list"></ul>
  </div>

  <form method="get" action="{% url 'events:events' %}" id="filterForm">
    <div class="filters">
      <div class="filter">
        <label for="department">Office/Department</label>
        <div class="department-select-wrapper">
          <select id="department" name="department">
            <option value="" disabled selected>Office / Dept.</option>
            {% for dept in departments %}
            <option value="{{ dept.DepartmentID }}">
              {{ dept.DepartmentName }}
            </option>
            {% endfor %}
          </select>
          {% if request.user.isUserAdmin %}
          <button type="button" class="dept-manage-btn" id="openDeptModal">Manage</button>
          {% endif %}
        </div>
      </div>

      <div class="filter">
        <label for="platform">Platform</label>
        <select id="platform" name="platform">
          <option value="">All Platforms</option>
          <option value="Zoom" {% if request.GET.platform == "Zoom" %}selected{% endif %}>Zoom</option>
          <option value="Teams" {% if request.GET.platform == "Teams" %}selected{% endif %}>Teams</option>
          <option value="Onsite" {% if request.GET.platform == "Onsite" %}selected{% endif %}>Onsite</option>
          <option value="Facebook" {% if request.GET.platform == "Facebook" %}selected{% endif %}>Facebook</option>
          <option value="YouTube" {% if request.GET.platform == "YouTube" %}selected{% endif %}>YouTube</option>
          <option value="TikTok" {% if request.GET.platform == "TikTok" %}selected{% endif %}>TikTok</option>
        </select>
      </div>

      <div class="filter">
        <label for="fromDate">From Date</label>
        <input type="date" id="fromDate" name="from_date" value="{{ request.GET.from_date }}">
      </div>

      <div class="filter">
        <label for="toDate">To Date</label>
        <input type="date" id="toDate" name="to_date" value="{{ request.GET.to_date }}">
      </div>

      <div class="filter-buttons">
        <button type="submit" class="btn apply">Apply Filters</button>
        <a href="{% url 'events:events' %}" class="btn clear">Clear All</a>
        <button type="button" class="btn export" onclick="exportToCSV()">Export to CSV</button>
      </div>
    </div>
  </form>

  <div class="results-wrapper">
    <aside class="sidebar">
      <h3 class="sidebar-title">Recent Events</h3>
      <ul class="event-list">
        {% for event in recent_events %}
        <li><a href="#">{{ event.EventTitle|truncatechars:30 }}</a></li>
        {% empty %}
        <li>No recent events</li>
        {% endfor %}
      </ul>
    </aside>

    <div class="results-content">
      {% if request.user.isUserAdmin or request.user.isUserStaff %}
      <div class="results-header-admin">
        <div class="results-header-top">
          <h2>Event Results</h2>
          <a href="{% url 'events:add_event' %}" class="add-event">Add Event</a>
        </div>
        <div class="results-header-bottom">
          <p class="results-meta">Showing {{ events|length }} of {{ events.paginator.count }} events</p>
          <span class="results-date">{% now "F Y" %}</span>
        </div>
      </div>
      {% else %}
      <div class="results-header">
        <h2>Event Results</h2>
        <span class="results-date">{% now "F Y" %}</span>
      </div>
      <p class="results-meta">Showing {{ events|length }} of {{ events.paginator.count }} events</p>
      {% endif %}

      {% for event in events %}
      <div class="event-card">
        <div class="event-card-header">
          <h3 class="event-title">{{ event.EventTitle }}</h3>
          <span class="event-date">üìÖ {{ event.EventDate|date:"F j, Y" }}</span>
        </div>

        <p class="event-department">
          {% with event.eventdepartment_set.first as dept %}
          {% if dept %}{{ dept.DepartmentID.DepartmentName }}{% else %}No Department{% endif %}
          {% endwith %}
        </p>

        {% if request.user.isUserAdmin or request.user.isUserStaff %}
        <div class="tags-and-actions-row">
          <div class="tags">
            {% for event_tag in event.eventtag_set.all %}
            <span class="tag green">{{ event_tag.TagID.TagName }}</span>
            {% empty %}
            <span class="tag">No tags</span>
            {% endfor %}
          </div>
          <div class="admin-actions-inline">
            <a 
              href="{% url 'events:events' %}?export=1&event_id={{ event.EventID }}" 
              class="action-btn export"
            >
              Export
            </a>
            
            <a href="{% url 'events:edit_event' EventID=event.EventID %}" class="action-btn edit">Edit</a>
            
            {% if request.user.isUserAdmin %}
            <a href="#" class="action-btn delete" data-event-id="{{ event.EventID }}"
              data-event-title="{{ event.EventTitle }}">
              Delete
            </a>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="tags">
          {% for event_tag in event.eventtag_set.all %}
          <span class="tag green">{{ event_tag.TagID.TagName }}</span>
          {% empty %}
          <span class="tag">No tags</span>
          {% endfor %}
        </div>
        {% endif %}

        <p class="event-desc">{{ event.EventDescription|truncatewords:30 }}</p>

        <div class="platforms">
          {% for link in event.eventlink_set.all %}
          <a href="{{ link.EventLinkURL }}" class="platform" target="_blank" rel="noopener noreferrer">
            {{ link.EventLinkName }}
          </a>
          {% empty %}
          <span class="platform">No links</span>
          {% endfor %}
        </div>
      </div>
      {% empty %}
      <div class="no-events">
        <p>No events found.
          {% if request.user.isUserAdmin or request.user.isUserStaff %}
          <a href="{% url 'events:add_event' %}">Add the first event</a>
          {% endif %}
        </p>
      </div>
      {% endfor %}

      {% if events.has_other_pages %}
      <div class="pagination">
        {% if events.has_previous %}
        <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if request.GET.department %}department={{ request.GET.department }}&{% endif %}{% if request.GET.platform %}platform={{ request.GET.platform }}&{% endif %}{% if request.GET.from_date %}from_date={{ request.GET.from_date }}&{% endif %}{% if request.GET.to_date %}to_date={{ request.GET.to_date }}&{% endif %}page={{ events.previous_page_number }}"
          class="btn prev">‚Üê Previous</a>
        {% endif %}
        {% if events.has_next %}
        <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if request.GET.department %}department={{ request.GET.department }}&{% endif %}{% if request.GET.platform %}platform={{ request.GET.platform }}&{% endif %}{% if request.GET.from_date %}from_date={{ request.GET.from_date }}&{% endif %}{% if request.GET.to_date %}to_date={{ request.GET.to_date }}&{% endif %}page={{ events.next_page_number }}"
          class="btn next">Next ‚Üí</a>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  {% if request.user.isUserAdmin %}

  <div id="deptModalOverlay" class="modal-overlay hidden">
    <div class="dept-modal">
      <h2>Manage Offices / Departments</h2>
      <ul class="dept-list">
        {% for dept in departments %}
        <li>
          <span>{{ dept.DepartmentName }}</span>
          <form method="post" action="{% url 'events:delete_department' dept.DepartmentID %}">
            {% csrf_token %}
            <button class="delete-dept-btn">Delete</button>
          </form>
        </li>
        {% endfor %}
      </ul>
      <form method="post" action="{% url 'events:add_department' %}" class="add-dept-form">
        {% csrf_token %}
        <input type="text" name="department_name" placeholder="Enter new office/department" required />
        <button type="submit">Add Department</button>
      </form>
      <button class="close-modal" id="closeDeptModal">Close</button>
    </div>
  </div>

   <!-- ‚úÖ Department Add/Delete Status Modal -->
  <div id="deptStatusModal" class="modal-overlay hidden">
    <div class="status-modal">
      <button class="close-x" id="closeDeptStatus">&times;</button>

      <div id="deptStatusIcon" class="modal-icon success">
        ‚úì
      </div>

      <h2 id="deptStatusTitle">Department Updated</h2>
      <p id="deptStatusMessage">
        The department list has been updated successfully.
      </p>
    </div>
  </div>

  <div id="deleteEventModal" class="modal-overlay hidden">
    <div class="delete-modal">
      <button class="close-x" id="closeDeleteModal">&times;</button>

      <div id="deleteModalIcon" class="modal-icon confirm">
        <img src="{% static 'events/images/trash.png' %}" alt="Delete">
      </div>

      <h2 id="deleteModalTitle">Delete Event?</h2>
      <p id="deleteModalMessage">
        Are you sure you want to delete this event?<br>
        This action cannot be undone.
      </p>

      <div id="deleteActionContainer" class="delete-actions">
        </div>
      
      <form method="post" id="deleteEventForm" style="display:none;">
        {% csrf_token %}
      </form>
    </div>
  </div>

  {% endif %}

</section>

<script>
  function exportToCSV() {
    const searchParams = new URLSearchParams(window.location.search);
    searchParams.set('export', '1');
    window.location.href = `${window.location.pathname}?${searchParams.toString()}`;
  }

  document.addEventListener('DOMContentLoaded', function () {
    const deletedStatus = sessionStorage.getItem("deleteStatus");
    if (deletedStatus === "success") {
      const deleteModal = document.getElementById("deleteEventModal");
      
      if(deleteModal) {
        deleteModal.classList.remove("hidden");
        // Show the success state directly
        showDeleteResult(true, "Event has been successfully deleted!");
      }
      
      // Clear the storage so it doesn't pop up again on refresh
      sessionStorage.removeItem("deleteStatus");
    }

    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');

    if (!fromDateInput.value) {
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      fromDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    if (!toDateInput.value) {
      toDateInput.value = new Date().toISOString().split('T')[0];
    }

    fromDateInput.addEventListener('change', function () {
      if (toDateInput.value && this.value > toDateInput.value) {
        toDateInput.value = this.value;
      }
    });

    toDateInput.addEventListener('change', function () {
      if (fromDateInput.value && this.value < fromDateInput.value) {
        this.value = fromDateInput.value;
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('q') && urlParams.get('q').trim() === '') {
      urlParams.delete('q');
      const newQuery = urlParams.toString();
      const newUrl = window.location.pathname + (newQuery ? '?' + newQuery : '');
      window.history.replaceState({}, '', newUrl);
    }

    // Instant Search
    const searchInput = document.querySelector('#search-input');
    const resultsBox = document.querySelector('.typeahead-list');
    let timer = null;

    searchInput.addEventListener('input', function () {
      const query = searchInput.value.trim();
      clearTimeout(timer);
      if (!query) {
        resultsBox.innerHTML = '';
        resultsBox.classList.remove('has-results');
        return;
      }
      timer = setTimeout(() => {
        const params = new URLSearchParams({
          q: query,
          limit: 5,
          department: document.getElementById('department').value,
          platform: document.getElementById('platform').value,
          fromDate: document.getElementById('fromDate').value,
          toDate: document.getElementById('toDate').value
        });

        fetch(`/events/search/?${params.toString()}`)
          .then(res => res.json())
          .then(data => {
            const results = data.results || [];
            if (results.length > 0) {
              resultsBox.innerHTML = results.map(r => `
                <li class="search-result-item">
                  <div class="search-result">
                    <strong>${r.title}</strong><br>
                    <small>${r.date} ‚Äî ${r.location}</small>
                  </div>
                </li>`).join('');
              resultsBox.classList.add('has-results');
            } else {
              resultsBox.innerHTML = '<li class="search-result-item">No events found</li>';
              resultsBox.classList.add('has-results');
            }
          })
          .catch(() => {
            resultsBox.innerHTML = '<li class="search-result-item">Error fetching results</li>';
            resultsBox.classList.add('has-results');
          });
      }, 200);
    });

    document.addEventListener('click', (e) => {
      if (!resultsBox.contains(e.target) && !searchInput.contains(e.target)) {
        resultsBox.innerHTML = '';
        resultsBox.classList.remove('has-results');
      }
    });
  });

  /* --- Department Modal Logic --- */
  const deptModal = document.getElementById("deptModalOverlay");
  const openDeptBtn = document.getElementById("openDeptModal");
  const closeDeptBtn = document.getElementById("closeDeptModal");

  if (openDeptBtn) {
    openDeptBtn.addEventListener("click", () => {
      deptModal.classList.remove("hidden");
    });
  }
  if (closeDeptBtn) {
    closeDeptBtn.addEventListener("click", () => {
      deptModal.classList.add("hidden");
    });
  }
  
  /* --- Department Status Modal + AJAX Add/Delete --- */
  const deptStatusModal   = document.getElementById("deptStatusModal");
  const deptStatusIcon    = document.getElementById("deptStatusIcon");
  const deptStatusTitle   = document.getElementById("deptStatusTitle");
  const deptStatusMessage = document.getElementById("deptStatusMessage");
  const closeDeptStatus   = document.getElementById("closeDeptStatus");
  const deptStatusOk      = document.getElementById("deptStatusOk");

  function showDeptStatus(type, message) {
    if (!deptStatusModal) return;

    // icon + color
    if (type === "success") {
      deptStatusIcon.className = "modal-icon success";
      deptStatusIcon.textContent = "‚úì";
      deptStatusTitle.textContent = "Department Updated";
    } else {
      deptStatusIcon.className = "modal-icon error";
      deptStatusIcon.textContent = "‚úï";
      deptStatusTitle.textContent = "Action Failed";
    }

    deptStatusMessage.textContent = message;
    deptStatusModal.classList.remove("hidden");
  }

  function closeDeptStatusModal() {
    deptStatusModal.classList.add("hidden");
    // reload so the department list + dropdown are up to date
    window.location.reload();
  }

  closeDeptStatus?.addEventListener("click", closeDeptStatusModal);
  deptStatusOk?.addEventListener("click", closeDeptStatusModal);

  // ‚úÖ Intercept DELETE department forms
  document.querySelectorAll(".dept-list form").forEach((form) => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const actionUrl = this.action;
      const deptName =
        this.closest("li")?.querySelector("span")?.textContent.trim() || "Department";

      fetch(actionUrl, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" },
      })
        .then((res) => {
          if (res.ok) {
            showDeptStatus("success", `"${deptName}" has been deleted.`);
          } else {
            showDeptStatus(
              "error",
              "Could not delete the department. Please try again."
            );
          }
        })
        .catch(() => {
          showDeptStatus(
            "error",
            "Network error occurred. Please try again."
          );
        });
    });
  });

  // ‚úÖ Intercept ADD department form
  const addDeptForm = document.querySelector(".add-dept-form");
  if (addDeptForm) {
    addDeptForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const actionUrl = this.action;
      const deptName = (formData.get("department_name") || "Department").toString();

      fetch(actionUrl, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" },
      })
        .then((res) => {
          if (res.ok) {
            showDeptStatus("success", `"${deptName}" has been added.`);
          } else {
            showDeptStatus(
              "error",
              "Could not add the department. Please check the name and try again."
            );
          }
        })
        .catch(() => {
          showDeptStatus(
            "error",
            "Network error occurred. Please try again."
          );
        });
    });
  }

  /* --- DELETE EVENT MODAL LOGIC --- */
  const deleteModal = document.getElementById("deleteEventModal");
  const deleteForm = document.getElementById("deleteEventForm");
  
  // UI Elements
  const uiIcon = document.getElementById("deleteModalIcon");
  const uiTitle = document.getElementById("deleteModalTitle");
  const uiMessage = document.getElementById("deleteModalMessage");
  const uiActions = document.getElementById("deleteActionContainer");
  const trashIconSrc = "{% static 'events/images/trash.png' %}"; 

  function resetDeleteUI() {
    uiIcon.className = "modal-icon confirm";
    uiIcon.innerHTML = `<img src="${trashIconSrc}" alt="Delete">`;
    
    uiTitle.textContent = "Delete Event?";
    uiTitle.className = ""; 
    
    uiMessage.innerHTML = "Are you sure you want to delete this event?<br>This action cannot be undone.";
    
    uiActions.style.display = "flex";
    uiActions.innerHTML = `
      <button type="button" class="cancel-btn" onclick="closeDeleteModalFunc()">Cancel</button>
      <button type="button" class="confirm-delete-btn" onclick="submitDeleteForm()">Delete Event</button>
    `;
  }

  function showDeleteResult(success, message) {
    if (success) {
      // Success
      uiIcon.className = "modal-icon success";
      uiIcon.innerHTML = "‚úì"; 
      uiTitle.textContent = "Event Deleted!";
      uiTitle.className = "text-success";
      uiMessage.textContent = message || "The event has been successfully deleted.";
      uiActions.innerHTML = '';
      
    } else {
      // Error
      uiIcon.className = "modal-icon error";
      uiIcon.innerHTML = "‚úï";
      uiTitle.textContent = "Deletion Failed";
      uiTitle.className = "text-error";
      uiMessage.textContent = message || "An error occurred. Please try again.";
      uiActions.innerHTML = '';
    }
  }

  function closeDeleteModalFunc() {
    deleteModal.classList.add("hidden");
  }

  function submitDeleteForm() {
    deleteForm.dispatchEvent(new Event('submit'));
  }

  // Open Modal Listener
  document.querySelectorAll(".action-btn.delete").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const eventId = btn.dataset.eventId;
      
      resetDeleteUI(); 
      
      deleteForm.action = `/events/delete/${eventId}/`;
      deleteModal.classList.remove("hidden");
    });
  });

  // Form Submission Logic
  if (deleteForm) {
    deleteForm.addEventListener("submit", function (e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const actionUrl = this.action;

      fetch(actionUrl, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => {
        if (response.ok) {
          // 1. Set flag in session storage
          sessionStorage.setItem("deleteStatus", "success");
          
          // 2. Reload page immediately
          location.reload();
          
        } else {
          // If error, show immediately (no reload needed)
          showDeleteResult(false, "Could not delete the event.");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showDeleteResult(false, "Network error occurred.");
      });
    });
  }

  document.getElementById("closeDeleteModal")?.addEventListener("click", () => {
    closeDeleteModalFunc();
  });

</script>
{% endblock %}